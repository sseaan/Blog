---
// src/pages/[...locale]/friendlink.astro

import type { MarkdownHeading } from "astro";
import { getEntry, render } from "astro:content";
import config, { monolocale } from "$config";
import Base from "$layouts/Base.astro";
import Icon from "$components/Icon.astro";
import TOC from "$components/note/TOC.astro";
import i18nit from "$i18n";
import Giscus from "$components/Giscus.svelte";
import { friendlinks } from "../../content/friendlinks";

export async function getStaticPaths() {
	return config.i18n.locales.map(locale => ({
		params: { locale: config.i18n.defaultLocale === locale ? undefined : locale }
	}));
}

const { locale = config.i18n.defaultLocale } = Astro.params;
const t = i18nit(locale);

// 获取友链内容
const friendlinksEntry = await getEntry("information", `${monolocale ? "" : locale}/friendlinks`);
const { Content, headings } = friendlinksEntry ? await render(friendlinksEntry) : { Content: null, headings: [] };

// 构建分层目录
type Heading = MarkdownHeading & { subheadings: Heading[] };
const tableOfContents: Heading[] = [];
const stack: Heading[] = [];

for (const item of headings) {
	while (stack.length > 0 && stack[stack.length - 1].depth >= item.depth) {
		stack.pop();
	}

	const heading: Heading = { ...item, subheadings: [] };

	if (stack.length > 0) {
		const parent = stack[stack.length - 1];
		parent.subheadings.push(heading);
	} else {
		tableOfContents.push(heading);
	}

	stack.push(heading);
}
---

<style>
	.friendlinks-wrapper {
		display: flex;
		gap: 2rem;

		.main-content {
			flex: 1;
			min-width: 0;

			.intro-section {
				margin-bottom: 3rem;
				padding-bottom: 2rem;
				border-bottom: 2px solid var(--block-color);

				:global(.markdown) {
					gap: 0.8rem;
				}
			}

			.category-section {
				margin-bottom: 3rem;
				scroll-margin-top: 80px;

				h2 {
					font-size: 1.5rem;
					margin-bottom: 1.5rem;
					padding-bottom: 0.5rem;
					border-bottom: 2px solid var(--primary-color);
				}

				.friendlinks-grid {
					display: grid;
					grid-template-columns: repeat(3, 1fr);
					gap: 1.5rem;

					@media (max-width: 1024px) {
						grid-template-columns: repeat(2, 1fr);
					}

					@media (max-width: 640px) {
						grid-template-columns: 1fr;
					}

					.friendlink-card {
						position: relative;
						display: flex;
						align-items: flex-start;
						gap: 1rem;
						padding: 1.25rem;
						border-radius: 0.75rem;
						border: 1px solid rgba(255, 255, 255, 0.5);
						box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
						transition: all 0.3s ease;
						cursor: pointer;
						text-decoration: none;
						overflow: hidden;
						backdrop-filter: blur(8px);
						-webkit-backdrop-filter: blur(8px);

						&::before {
							content: "";
							position: absolute;
							top: 0;
							left: 0;
							width: 50%;
							height: 100%;
							background-image: var(--bg-image);
							background-size: cover;
							background-position: center;
							background-repeat: no-repeat;
							opacity: 0.25;
							z-index: 0;
						}

						&::after {
							display: none;
						}

						&:hover {
							border-color: rgba(255, 255, 255, 0.7);
							box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
							transform: translateY(-2px);
						}

						&:hover::after {
							background: rgba(255, 255, 255, 0.55);
						}

						@media (prefers-color-scheme: dark) {
							border: 1px solid rgba(255, 255, 255, 0.1);
						}

						@media (prefers-color-scheme: dark) {
							&::after {
								background: rgba(255, 255, 255, 0.06);
							}

							&:hover::after {
								background: rgba(255, 255, 255, 0.1);
							}
						}

						[data-theme="dark"] & {
							border: 1px solid rgba(255, 255, 255, 0.1);

							&::after {
								background: rgba(255, 255, 255, 0.06);
							}
						}

						[data-theme="dark"] &:hover::after {
							background: rgba(255, 255, 255, 0.1);
						}

						[data-theme="light"] & {
							border: 1px solid rgba(255, 255, 255, 0.5);

							&::after {
								background: rgba(255, 255, 255, 0.4);
							}
						}

						[data-theme="light"] &:hover::after {
							background: rgba(255, 255, 255, 0.55);
						}
					}

					.friendlink-card .avatar {
						position: relative;
						z-index: 2;
						width: 48px;
						height: 48px;
						min-width: 48px;
						border-radius: 50%;
						object-fit: cover;
					}

					.friendlink-card .content {
						position: relative;
						z-index: 2;
						flex: 1;
						min-width: 0;
						display: flex;
						flex-direction: column;
						gap: 0.3rem;
					}

					.friendlink-card .content .name {
						font-weight: 600;
						font-size: 0.95rem;
						color: var(--primary-color);
						line-height: 1.2;
					}

					.friendlink-card .content .description {
						font-size: 0.8rem;
						color: var(--remark-color);
						line-height: 1.4;
						display: -webkit-box;
						-webkit-line-clamp: 2;
						-webkit-box-orient: vertical;
						overflow: hidden;
					}

						.avatar {
							width: 40px;
							height: 40px;
							min-width: 40px;
							border-radius: 50%;
							object-fit: cover;
						}

						.content {
							flex: 1;
							min-width: 0;
							display: flex;
							flex-direction: column;
							gap: 0.2rem;

							.name {
								font-weight: 600;
								font-size: 0.9rem;
								color: var(--primary-color);
								line-height: 1.2;
							}

							.description {
								font-size: 0.75rem;
								color: var(--remark-color);
								line-height: 1.3;
								display: -webkit-box;
								-webkit-line-clamp: 2;
								-webkit-box-orient: vertical;
								overflow: hidden;
							}
						}
					}
				}
			}
		}

		.sidebar {
			display: none;

			@media (min-width: 640px) {
				display: block;
				flex-shrink: 0;
				width: 200px;

				.sticky-toc {
					position: sticky;
					top: 60px;
					display: flex;
					flex-direction: column;
					gap: 1rem;

					h3 {
						font-size: 0.95rem;
						font-weight: bold;
					}

					nav {
						overflow-y: auto;
						max-height: calc(100vh - 120px);
					}
				}
			}
		}

		@media (max-width: 1200px) {
			flex-direction: column;

			.sidebar {
				display: none !important;
			}
		}
	}
</style>

<Base title={t("navigation.friendlink")} locale={locale} description={t("friendlink.description")}>
	<main class="flex flex-col gap-6">
		<header class="flex flex-col gap-4">
			<h1 class="text-3xl">{t("navigation.friendlink")}</h1>
			<hr class="b-b b-b-solid b-weak" />
		</header>

		<div class="friendlinks-wrapper">
			<div class="main-content">
				{Content && (
					<section class="intro-section markdown">
						<Content />
					</section>
				)}

				{friendlinks.map((category) => (
					<section class="category-section" id={`category-${category.category}`}>
						<h2>{category.category}</h2>
						<div class="friendlinks-grid">
							{category.links.map((link) => (
								<a 
									href={link.url} 
									target="_blank" 
									rel="noopener noreferrer" 
									class="friendlink-card"
									style={`--bg-image: url(${link.avatar})`}
								>
									<img src={link.avatar} alt={link.name} class="avatar" />
									<div class="content">
										<div class="name">{link.name}</div>
										<div class="description">{link.description}</div>
									</div>
								</a>
							))}
						</div>
					</section>
				))}
			</div>

			{tableOfContents.length > 0 && (
				<aside class="sidebar">
					<div class="sticky-toc">
						<h3>{t("note.contents")}</h3>
						<nav>
							<TOC headings={tableOfContents} />
						</nav>
					</div>
				</aside>
			)}
		</div>

		<hr class="b-b b-b-solid b-weak my-4" />

		<Giscus 
			client:load
			repo="Yaten-Z/blog-giscus"
			repoId="R_kgDOOzg2eg"
			category="Announcements"
			categoryId="DIC_kwDOOzg2es4Cq1Mo"
			lang="zh-CN"
			lightTheme="noborder_light"
			darkTheme="noborder_dark"
		/>
	</main>
</Base>
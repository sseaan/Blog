---
import { getCollection, getEntry, render } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import { monolocale } from "$config";
import i18nit from "$i18n";

let { locale, author, copyright } = Astro.props;

const t = i18nit(locale);

let ccURL: string;
let ccLabel: string;

// 博客启动日期（用于客户端计算）
const launchTime = new Date("2025-05-25").getTime();

// 导航显示链接
const navLinks = [
	{ title: "首页", url: "/" },
	{ title: "文章", url: "/note" },
	{ title: "随笔", url: "/jotting" },
	{ title: "关于", url: "/about" },
	{ title: "友链", url: "/links" },
	{ title: "留言", url: "/message" }
];

switch (copyright.type) {
	case "CC BY 4.0":
		ccURL = "https://creativecommons.org/licenses/by/4.0/";
		ccLabel = "Attribution 4.0 International";
		break;
	case "CC BY-SA 4.0":
		ccURL = "https://creativecommons.org/licenses/by-sa/4.0/";
		ccLabel = "Attribution-ShareAlike 4.0 International";
		break;
	case "CC BY-NC 4.0":
		ccURL = "https://creativecommons.org/licenses/by-nc/4.0/";
		ccLabel = "Creative Commons Attribution-NonCommercial 4.0 International";
		break;
	case "CC BY-NC-SA 4.0":
		ccURL = "https://creativecommons.org/licenses/by-nc-sa/4.0/";
		ccLabel = "Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International";
		break;
	case "CC BY-ND 4.0":
		ccURL = "https://creativecommons.org/licenses/by-nd/4.0/";
		ccLabel = "Creative Commons Attribution-NoDerivatives 4.0 International";
		break;
	case "CC BY-NC-ND 4.0":
		ccURL = "https://creativecommons.org/licenses/by-nc-nd/4.0/";
		ccLabel = "Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International";
		break;
	default:
		ccURL = "https://creativecommons.org/publicdomain/zero/1.0/";
		ccLabel = "CC0 1.0 Universal";
		break;
}

const ccIcons = ["fa6-brands:creative-commons"];
if (copyright.type === "CC0 1.0") {
	ccIcons.push("fa6-brands:creative-commons-zero");
} else {
	if (copyright.type.includes("BY")) ccIcons.push("fa6-brands:creative-commons-by");
	if (copyright.type.includes("NC")) ccIcons.push("fa6-brands:creative-commons-nc");
	if (copyright.type.includes("SA")) ccIcons.push("fa6-brands:creative-commons-sa");
	if (copyright.type.includes("ND")) ccIcons.push("fa6-brands:creative-commons-nd");
}

// 寻找文章数据
const notes = await getCollection("note", note => {
	let published = !note.data.draft;
	let localed = monolocale || note.id.split("/")[0] === locale;
	return published && localed;
});

const noteWords = (await Promise.all(notes.map(async note => (await render(note)).remarkPluginFrontmatter.words))).reduce(
	(summary, words) => summary + words,
	0
);

const jottings = await getCollection("jotting", jotting => {
	let published = !jotting.data.draft;
	let localed = monolocale || jotting.id.split("/")[0] === locale;
	return published && localed;
});

const jottingWords = (await Promise.all(jottings.map(async jotting => (await render(jotting)).remarkPluginFrontmatter.words))).reduce(
	(summary, words) => summary + words,
	0
);

const totalWords = noteWords + jottingWords;

// 获取最近文章
const latestArticles = [...notes, ...jottings]
	.filter(item => !item.data.draft)
	.sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime())
	.slice(0, 6); // 取最近 6 篇文章，可根据需要调整数量

// Policy
const policy = await getEntry("information", `${locale}/policy`);
---

<style lang="less">
	footer {
		margin-top: 2rem;
		padding: 1.5rem 0 1rem;
		border-top: 1px solid var(--block-color);

		.footer-container {
			display: grid;
			grid-template-columns: 1.2fr 1fr 1.5fr;
			gap: 2rem;
			max-width: 1000px;
			margin: 0 auto;
			padding: 0 1rem;

			@media (max-width: 768px) {
				grid-template-columns: 1fr;
				gap: 1.5rem;
			}
		}

		.footer-column {
			h3 {
				font-size: 0.95rem;
				font-weight: 600;
				margin-bottom: 0.8rem;
				color: var(--primary-color);
			}
		}

		// Left column - About
		.column-left {
			.intro-text {
				line-height: 1.6;
				color: var(--secondary-color);
				font-size: 0.85rem;
				margin-bottom: 0.8rem;

				.highlight {
					font-weight: 600;
					color: var(--primary-color);
				}
			}
		}

		// Center column - Navigation
		.column-center {
			.nav-list {
				display: grid;
				grid-template-columns: 2fr 3fr;
				gap: 0.4rem 0.8rem;

				a {
					color: var(--secondary-color);
					text-decoration: none;
					font-size: 0.85rem;
					padding: 0.2rem 0;
					transition: color 0.15s ease-in-out;

					&:hover {
						color: var(--primary-color);
					}
				}
			}

			.extra-info {
				margin-top: 1rem;

				h4 {
					font-size: 0.9rem;
					font-weight: 600;
					margin-bottom: 0.5rem;
					color: var(--primary-color);
				}

				.info-item {
					font-size: 0.8rem;
					color: var(--remark-color);
					margin-bottom: 0.5rem;

					a {
						color: var(--secondary-color);
						text-decoration: none;
						transition: color 0.15s ease-in-out;

						&:hover {
							color: var(--primary-color);
						}
					}
				}
			}
		}

		// Right column - Recent articles
		.column-right {
			.articles-list {
				display: flex;
				flex-direction: column;
				gap: 0.4rem;

				.article-link {
					padding: 0.3rem 0;
					text-decoration: none;
					color: var(--secondary-color);
					font-size: 0.85rem;
					transition: color 0.15s ease-in-out;
					border-bottom: 1px solid transparent;

					&:hover {
						color: var(--primary-color);
						border-bottom-color: var(--primary-color);
					}

					.article-date {
						font-size: 0.75rem;
						color: var(--weak-color);
						margin-left: 0.5rem;
					}
				}
			}

			.no-articles {
				color: var(--weak-color);
				font-size: 0.85rem;
			}
		}
	}

	.footer-bottom {
		margin-top: 1rem;
		padding-top: 1rem;
		border-top: 1px solid var(--block-color);
		text-align: center;

		.bottom-info {
			font-size: 0.75rem;
			color: var(--weak-color);
			display: flex;
			justify-content: center;
			gap: 0.8rem;
			flex-wrap: wrap;
			align-items: center;

			a {
				color: var(--weak-color);
				text-decoration: none;
				transition: color 0.15s ease-in-out;

				&:hover {
					color: var(--secondary-color);
				}
			}
		}
	}
</style>

<footer>
	<div class="footer-container">
		<!-- Left Column - About -->
		<div class="footer-column column-left">
			<h3>关于本站</h3>
			<p class="intro-text">
				Hello! 我是 Yaten，这是我的个人博客，<br>在这里我会分享我的学习笔记、生活随笔<br>以及各种有趣的内容。
			</p>
			<p class="intro-text">
				本站至今已经运行了 <span class="highlight" id="days-running">...</span> 天，<br>写下 <span class="highlight">{notes.length + jottings.length}</span> 篇文章，共计 <span class="highlight">{totalWords}</span> 字。
			</p>
		</div>

		<!-- Center Column - Navigation -->
		<div class="footer-column column-center">
			<h3>导航</h3>
			<div class="nav-list">
				{navLinks.map(link => {
					const isExternal = link.url.startsWith("http");
					return isExternal ? (
						<a href={link.url} target="_blank" rel="noopener noreferrer">
							{link.title}
						</a>
					) : (
						<a href={getRelativeLocaleUrl(locale, link.url)}>
							{link.title}
						</a>
					);
				})}
			</div>

			<div class="extra-info">
				<h4>联系方式</h4>
				<!-- 修改联系方式 -->
				<div class="info-item">
					<a href="https://github.com/Yaten-Z" target="_blank">GitHub: Yaten-Z</a>
				</div>
				<div class="info-item">
					<a href="mailto:Yaten-Z@outlook.com">Email: Yaten-Z@outlook.com</a>
				</div>
				<div class="info-item">
					<a href="https://qm.qq.com/q/IyIRVq6vwQ" target="_blank">QQ: 2635802854</a>
				</div>
			</div>
		</div>

		<!-- Right Column - Recent articles -->
		<div class="footer-column column-right">
			<h3>最近文章</h3>
			{latestArticles.length > 0 ? (
				<div class="articles-list">
					{latestArticles.map((item) => {
						const itemType = item.collection === "note" ? "note" : "jotting";
						const date = new Date(item.data.timestamp).toLocaleDateString(locale);
						return (
							<a
								href={getRelativeLocaleUrl(locale, `/${itemType}/${item.id.split("/").slice(1).join("/")}`)}
								class="article-link"
							>
								{item.data.title}
								<span class="article-date">{date}</span>
							</a>
						);
					})}
				</div>
			) : (
				<div class="no-articles">暂无推荐</div>
			)}
		</div>
	</div>

	<div class="footer-bottom">
		<div class="bottom-info">
			{copyright.type != "CC0 1.0" && [
				<span>©</span>,
				<span>{copyright.year}</span>
			]}
			<span>
				{typeof author === "string" ? author : author.link ? <a href={author.link} target="_blank">{author.name}</a> : author.name}
			</span>
			<span>·</span>
			<a target="_blank" href={ccURL} title={ccLabel}>
				{copyright.type}
			</a>
			<span>·</span>
			<span>
				Powered by <a href="https://astro.build/" target="_blank">Astro</a>
			</span>
		</div>
	</div>
</footer>

<script>
	// 动态计算运行天数
	const launchTime = new Date("2025-05-25").getTime();

	function updateDaysRunning() {
		const now = Date.now();
		const daysRunning = Math.floor((now - launchTime) / (1000 * 60 * 60 * 24));
		const element = document.getElementById('days-running');
		if (element) {
			element.textContent = daysRunning.toString();
		}
	}

	// 页面加载时更新
	updateDaysRunning();

	// 每天午夜更新一次
	function scheduleNextUpdate() {
		const now = new Date();
		const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
		const timeUntilTomorrow = tomorrow.getTime() - now.getTime();
		setTimeout(() => {
			updateDaysRunning();
			scheduleNextUpdate();
		}, timeUntilTomorrow);
	}

	scheduleNextUpdate();
</script>